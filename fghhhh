#!/usr/bin/env python3
import asyncio
import logging
import datetime
from typing import Dict, Any

from aiogram import Bot, Dispatcher
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

logger = logging.getLogger("pill_bot")

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
API_TOKEN = '8165334459:AAHlZkOCIMDHbcW29NN_hW6iBE47Y5_nt5Q'

# ========== –í–†–ï–ú–Ø –ü–†–ò–ï–ú–ê –¢–ê–ë–õ–ï–¢–û–ö ==========
PILL_HOUR = 16    # 16 —á–∞—Å–æ–≤ –¥–Ω—è
PILL_MINUTE = 30 # 30 –º–∏–Ω—É—Ç
# 16:30 –¥–Ω—è

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# ========== –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• ==========
user_states: Dict[int, Dict[str, Any]] = {}

# ========== –¢–ï–ö–°–¢–´ –°–û–û–ë–©–ï–ù–ò–ô ==========
WELCOME_TEXT = f"""
üíä *–í—Å–ø–æ–º–∏–Ω–∞–µ–º –æ –ø—Ä–∏–µ–º–µ —Ç–∞–±–ª–µ—Ç–æ—á–µ–∫)*

–≠—Ç–æ –∫–∞–∫ –≤—Å–µ–≥–¥–∞ —Ç–≤–æ–π –ö–∏—Ä–∏–ª–ªü•∞
–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–∞–±–ª–µ—Ç–æ—á–∫–∏
–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ {PILL_HOUR:02d}:{PILL_MINUTE:02d} —è –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
"""

PILL_TAKEN_TEXT = """
‚ô•Ô∏è *–ß—É–¥–µ—Å–Ω–æ, —Ç—ã —É–º–Ω–∏—á–∫–∞! –ï—â—ë –æ–¥–Ω–∞ —Ç–∞–±–ª–µ—Ç–∫–∞ –≤—ã–ø–∏—Ç–∞.üî•üí™ü•∞*

–ó–∞–ø–∏—Å—å –æ –ø—Ä–∏–µ–º–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ü§ó.
"""

PILL_REFUSED_TEXT = """
‚ùå *–¢—ã –æ—Ç–∫–∞–∑–∞–ª–∞—Å—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–∞–±–ª–µ—Ç–æ—á–∫–∏?
–ê—Ä–∏–Ω–∞...., —Ç—ã —á–µ–≥–æ –∞—Ö–∞—Ö–∞—Ö–∞—Ö—Ö.*

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Å—å –∏ –ø—Ä–∏–º–∏ –∏—Öüíã.
"""

REMINDER_TEXT = f"""
‚è∞ *–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –û –ü–†–ò–ï–ú–ï –¢–ê–ë–õ–ï–¢–û–ß–ï–ö*

–°–æ–ª–Ω—ã—à–∫–æ, –ø–æ—Ä–∞ –ø–∏—Ç—å —Ç–∞–±–ª–µ—Ç–æ—á–∫–∏! 
–Ø –∑–Ω–∞—é —Ç—ã –Ω–µ –ª—é–±–∏—à—å, –Ω–æ –Ω–∞–¥–æ‚ù§Ô∏è
–î–∞–π –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Ç–µ–±–µ üòö
–í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞: {PILL_HOUR:02d}:{PILL_MINUTE:02d}
"""

# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ö–ù–û–ü–û–ö ==========

def create_main_keyboard():
    keyboard = [
        [InlineKeyboardButton(text="–í—Ä–µ–º—è –¥–æ –ø—Ä–∏—ë–º–∞ —Ç–∞–±–ª–µ—Ç–æ—á–µ–∫", callback_data="time_to_pill")],
        [InlineKeyboardButton(text="–û—Ç—á—ë—Ç –æ –ø—Ä–∏—ë–º–µ —Ç–∞–±–ª–µ—Ç–∫–∏", callback_data="pill_report")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def create_report_keyboard():
    keyboard = [
        [InlineKeyboardButton(text="–Ø –≤—ã–ø–∏–ª–∞)", callback_data="pill_taken")],
        [InlineKeyboardButton(text="–ù–µ–µ, –Ω–µ —Ö–æ—á—É)", callback_data="pill_refused")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def create_back_to_pill_keyboard():
    keyboard = [
        [InlineKeyboardButton(text="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥ –∏ –±—ã—Å—Ç—Ä–µ–Ω—å–∫–æ –≤—ã–ø–∏—Ç—å —Ç–∞–±–ª–µ—Ç–∫—Éü§óü•∞)", callback_data="back_to_pill")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

def create_back_to_main_keyboard():
    keyboard = [
        [InlineKeyboardButton(text="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é", callback_data="back_to_main")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========

@dp.message(CommandStart())
async def handle_start(message: Message):
    try:
        user_id = message.from_user.id
        username = message.from_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        
        user_states[user_id] = {
            'started': True,
            'username': username,
            'join_date': datetime.datetime.now().isoformat()
        }
        
        logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id} ({username})")
        
        await message.answer(
            WELCOME_TEXT,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=create_main_keyboard()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_start: {e}")
        await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ==========

@dp.callback_query(lambda c: c.data == "time_to_pill")
async def handle_time_to_pill(callback: CallbackQuery):
    try:
        await callback.answer()
        
        now = datetime.datetime.now()
        target_time = now.replace(hour=PILL_HOUR, minute=PILL_MINUTE, second=0, microsecond=0)
        
        if now >= target_time:
            target_time += datetime.timedelta(days=1)
        
        time_left = target_time - now
        hours = time_left.seconds // 3600
        minutes = (time_left.seconds % 3600) // 60
        
        # –ï—Å–ª–∏ –º–µ–Ω—å—à–µ —á–∞—Å–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–∏–Ω—É—Ç—ã
        if hours == 0:
            time_text = f"{minutes} –º–∏–Ω."
        else:
            time_text = f"{hours} —á. {minutes} –º–∏–Ω."
        
        response = (
            f"‚è∞üíã *–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:* {now.strftime('%H:%M')}\n"
            f"‚è≥‚ù§Ô∏è *–î–æ –ø—Ä–∏—ë–º–∞ —Ç–∞–±–ª–µ—Ç–æ—á–µ–∫:* {time_text}\n"
            f"üíäü•∞ *–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏—ë–º —Ç–∞–±–ª–µ—Ç–æ—á–µ–∫:* {PILL_HOUR:02d}:{PILL_MINUTE:02d}"
        )
        
        await callback.message.answer(
            response,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=create_main_keyboard()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_time_to_pill: {e}")

@dp.callback_query(lambda c: c.data == "pill_report")
async def handle_pill_report(callback: CallbackQuery):
    try:
        await callback.answer()
        await callback.message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=create_report_keyboard()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_pill_report: {e}")

@dp.callback_query(lambda c: c.data == "pill_taken")
async def handle_pill_taken(callback: CallbackQuery):
    try:
        await callback.answer("–û—Ç–ª–∏—á–Ω–æ! üòö")
        
        user_id = callback.from_user.id
        now = datetime.datetime.now()
        
        user_states[user_id]['last_taken'] = now.isoformat()
        user_states[user_id]['status'] = 'taken'
        
        response = PILL_TAKEN_TEXT + f"\n\nüïí *–í—Ä–µ–º—è –ø—Ä–∏—ë–º–∞:* {now.strftime('%H:%M:%S')}"
        
        await callback.message.answer(
            response,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=create_back_to_main_keyboard()
        )
        
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–∏–Ω—è–ª —Ç–∞–±–ª–µ—Ç–∫—É –≤ {now}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_pill_taken: {e}")

@dp.callback_query(lambda c: c.data == "pill_refused")
async def handle_pill_refused(callback: CallbackQuery):
    try:
        await callback.answer()
        
        user_id = callback.from_user.id
        user_states[user_id]['status'] = 'refused'
        
        await callback.message.answer(
            PILL_REFUSED_TEXT,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=create_back_to_pill_keyboard()
        )
        
        logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç —Ç–∞–±–ª–µ—Ç–∫–∏")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_pill_refused: {e}")

@dp.callback_query(lambda c: c.data == "back_to_pill")
async def handle_back_to_pill(callback: CallbackQuery):
    try:
        await callback.answer()
        await callback.message.answer(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏ —Ç–∞–±–ª–µ—Ç–æ—á–∫—É) :",
            reply_markup=create_report_keyboard()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_back_to_pill: {e}")

@dp.callback_query(lambda c: c.data == "back_to_main")
async def handle_back_to_main(callback: CallbackQuery):
    try:
        await callback.answer()
        await callback.message.answer(
            "–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é...",
            reply_markup=create_main_keyboard()
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ handle_back_to_main: {e}")

# ========== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ï–ñ–ï–î–ù–ï–í–ù–´–• –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ô ==========

async def check_daily_reminder():
    while True:
        try:
            now = datetime.datetime.now()
            current_hour = now.hour
            current_minute = now.minute
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ (02:15)
            if current_hour == PILL_HOUR and current_minute == PILL_MINUTE:
                logger.info(f"‚è∞ü•π –í—Ä–µ–º—è {PILL_HOUR:02d}:{PILL_MINUTE:02d}! –û—Ç–ø—Ä–∞–≤–ª—è—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è...")
                
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è –ª–æ–≥–æ–≤
                current_time_str = now.strftime('%H:%M:%S')
                current_date_str = now.strftime('%Y-%m-%d')
                
                for user_id, user_data in list(user_states.items()):
                    try:
                        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                        reminder_message = (
                            f"‚è∞ *–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –û –ü–†–ò–ï–ú–ï –¢–ê–ë–õ–ï–¢–û–ß–ï–öü§ó*\n\n"
                            f"–°–æ–ª–Ω—ã—à–∫–æ, –ø–æ—Ä–∞ –≤—ã–ø–∏—Ç—å —Ç–∞–±–ª–µ—Ç–æ—á–∫–∏üòö‚ù§Ô∏è!\n"
                            f"üïí *–í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞:* {PILL_HOUR:02d}:{PILL_MINUTE:02d}\n"
                            f"üìÖ *–î–∞—Ç–∞:* {current_date_str}"
                        )
                        
                        await bot.send_message(
                            chat_id=user_id,
                            text=reminder_message,
                            parse_mode=ParseMode.MARKDOWN,
                            reply_markup=create_main_keyboard()
                        )
                        
                        logger.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –≤ {current_time_str}")
                        
                    except Exception as e:
                        error_msg = str(e)
                        logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {error_msg}")
                        
                        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞
                        if any(phrase in error_msg.lower() for phrase in ["chat not found", "user is deactivated", "bot was blocked", "forbidden"]):
                            logger.warning(f"üóëÔ∏è –£–¥–∞–ª—è—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∏–∑ —Å–ø–∏—Å–∫–∞ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞)")
                            del user_states[user_id]
                
                # –ñ–¥–µ–º 1 –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç—É –∂–µ –º–∏–Ω—É—Ç—É
                await asyncio.sleep(60)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏)
            await asyncio.sleep(30)
            
        except Exception as e:
            logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}")
            await asyncio.sleep(60)

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

async def main():
    try:
        logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
        logger.info(f"üíä –í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ —Ç–∞–±–ª–µ—Ç–æ–∫: {PILL_HOUR:02d}:{PILL_MINUTE:02d}")
        logger.info(f"üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {datetime.datetime.now().strftime('%Y-%m-%d')}")
        logger.info(f"‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {datetime.datetime.now().strftime('%H:%M:%S')}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API
        try:
            me = await bot.get_me()
            logger.info(f"‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!")
            logger.info(f"   –ò–º—è –±–æ—Ç–∞: {me.first_name}")
            logger.info(f"   Username: @{me.username}")
            logger.info(f"   ID –±–æ—Ç–∞: {me.id}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram API: {e}")
            logger.error("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
            logger.error("   1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞")
            logger.error("   2. –ù–∞–ª–∏—á–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
            logger.error("   3. –ù–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –±–æ—Ç –≤ Telegram")
            return
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
        logger.info("üîß –ó–∞–ø—É—Å–∫–∞—é —Å–ª—É–∂–±—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π...")
        reminder_task = asyncio.create_task(check_daily_reminder())
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –±–æ—Ç–∞
        logger.info("üì° –ó–∞–ø—É—Å–∫–∞—é –æ–ø—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–π...")
        logger.info("=" * 50)
        logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –≤ Telegram")
        logger.info("=" * 50)
        
        await dp.start_polling(bot, skip_updates=True)
        
    except KeyboardInterrupt:
        logger.info("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C)")
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        logger.error(f"üîç –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ—à–∏–±–∫–∏:\n{traceback.format_exc()}")
    finally:
        logger.info("üîÑ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞...")
        await bot.session.close()
        logger.info("üëã –ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")

if __name__ == "__main__":
    asyncio.run(main())